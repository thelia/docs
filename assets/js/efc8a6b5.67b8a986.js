"use strict";(self.webpackChunkthelia=self.webpackChunkthelia||[]).push([[5732],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),p=d(n),m=o,h=p["".concat(s,".").concat(m)]||p[m]||c[m]||r;return n?a.createElement(h,l(l({ref:t},u),{},{components:n})):a.createElement(h,l({ref:t},u))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,l=new Array(r);l[0]=p;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:o,l[1]=i;for(var d=2;d<r;d++)l[d]=n[d];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},7845:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>c,frontMatter:()=>r,metadata:()=>i,toc:()=>d});var a=n(7462),o=(n(7294),n(3905));const r={title:"Propel",sidebar_position:4},l=void 0,i={unversionedId:"propel",id:"propel",title:"Propel",description:"Thelia uses the Propel 2 orm to interact with database.",source:"@site/docs/propel.md",sourceDirName:".",slug:"/propel",permalink:"/docs/propel",draft:!1,editUrl:"https://github.com/thelia/docs/edit/main/docs/propel.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Propel",sidebar_position:4},sidebar:"myAutogeneratedSidebar",previous:{title:"Extending Thelia",permalink:"/docs/extending_thelia"},next:{title:"Template",permalink:"/docs/template"}},s={},d=[{value:"Describing schema",id:"describing-schema",level:2},{value:"Generate Sql / Model from schema",id:"generate-sql--model-from-schema",level:2},{value:"Execute Sql",id:"execute-sql",level:2},{value:"At module initialization",id:"at-module-initialization",level:3},{value:"On module update",id:"on-module-update",level:3},{value:"Add a column to native Thelia table",id:"add-a-column-to-native-thelia-table",level:2}],u={toc:d};function c(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Thelia uses the ",(0,o.kt)("a",{parentName:"p",href:"http://propelorm.org/"},"Propel 2")," orm to interact with database."),(0,o.kt)("h2",{id:"describing-schema"},"Describing schema"),(0,o.kt)("p",null,"To add new table in Thelia you have to describe it in your schema located here ",(0,o.kt)("inlineCode",{parentName:"p"},"MyModule/Config/schema.xml")," please refer to ",(0,o.kt)("a",{parentName:"p",href:"http://propelorm.org/documentation/reference/schema.html"},"propel documentation")," to know how to do it."),(0,o.kt)("h2",{id:"generate-sql--model-from-schema"},"Generate Sql / Model from schema"),(0,o.kt)("p",null,"To generate Sql request and associated model class from schema use this command"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"php Thelia module:generate:model --generate-sql MyProject \n")),(0,o.kt)("p",null,"This command will generate a TheliaMain.sql file at ",(0,o.kt)("inlineCode",{parentName:"p"},"local/modules/MyProject/Confif/TheliaMain.sql")," don't modify it, it will be erased each time this command is executed.",(0,o.kt)("br",{parentName:"p"}),"\n","It will also generate ",(0,o.kt)("a",{parentName:"p",href:"http://propelorm.org/documentation/reference/active-record.html"},"Model")," and ",(0,o.kt)("a",{parentName:"p",href:"http://propelorm.org/documentation/reference/model-criteria.html"},"ModelQuery")," file for each table, in these files you can add your own functions or properties, they will not be erased as they are just empty class that extend the real propel Model located in propel cache."),(0,o.kt)("h2",{id:"execute-sql"},"Execute Sql"),(0,o.kt)("h3",{id:"at-module-initialization"},"At module initialization"),(0,o.kt)("p",null,"If you want to execute the sql at the first module activation add this function to your module's base file :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"    public function postActivation(ConnectionInterface $con = null): void\n    {\n        // Look if module has already been activated \n        if (!self::getConfigValue('is_initialized', false)) {\n            $database = new Database($con);\n            // Insert generated file\n            $database->insertSql(null, [__DIR__.'/Config/TheliaMain.sql']);\n            \n            // Set module as initialized\n            self::setConfigValue('is_initialized', true);\n        }\n    }\n")),(0,o.kt)("h3",{id:"on-module-update"},"On module update"),(0,o.kt)("p",null,"If your module has already been activated you must go through the update system.\nFor now there is no way to get directly the sql request needed to update your database, you need to extract it from the generated TheliaMain.sql."),(0,o.kt)("p",null,"For example if at module initialization you have this sql generated :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"DROP TABLE IF EXISTS `block_group`;\n\nCREATE TABLE `block_group`\n(\n    `id` INTEGER NOT NULL AUTO_INCREMENT,\n    `slug` VARCHAR(50),\n    `created_at` DATETIME,\n    `updated_at` DATETIME,\n    PRIMARY KEY (`id`),\n    UNIQUE INDEX `slug_unique` (`slug`)\n) ENGINE=InnoDB;\n")),(0,o.kt)("p",null,'And later you want to add a new boolean column named "visible" to you table you will add it to your shema.xml and get this sql :'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"DROP TABLE IF EXISTS `block_group`;\n\nCREATE TABLE `block_group`\n(\n    `id` INTEGER NOT NULL AUTO_INCREMENT,\n    `slug` VARCHAR(50),\n    `visible` TINYINT DEFAULT 0 NOT NULL,\n    `created_at` DATETIME,\n    `updated_at` DATETIME,\n    PRIMARY KEY (`id`),\n    UNIQUE INDEX `slug_unique` (`slug`)\n) ENGINE=InnoDB;\n")),(0,o.kt)("p",null,"So you have to extract only the difference like this"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"ALTER TABLE `block_group` ADD `visible` TINYINT DEFAULT 0 NOT NULL;\n")),(0,o.kt)("p",null,"Then put this extracted requests on a new file located here ",(0,o.kt)("inlineCode",{parentName:"p"},"local/modules/MyProject/Config/update/")," the name of the file must be the next version of your module. For instance, if the version of your module is ",(0,o.kt)("inlineCode",{parentName:"p"},"1.0.6")," and the next version is ",(0,o.kt)("inlineCode",{parentName:"p"},"1.1.0"),", create this file ",(0,o.kt)("inlineCode",{parentName:"p"},"local/modules/MyProject/Config/update/1.1.0.sql")," and put the sql in it and change the ",(0,o.kt)("inlineCode",{parentName:"p"},"<version></version>")," in module.xml.",(0,o.kt)("br",{parentName:"p"}),"\n","Make sure that you have this function in your base file :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"    /**\n     * Execute sql files in Config/update/ folder named with module version (ex: 1.0.1.sql).\n     *\n     * @param $currentVersion\n     * @param $newVersion\n     * @param ConnectionInterface $con\n     */\n    public function update($currentVersion, $newVersion, ConnectionInterface $con = null): void\n    {\n        $finder = Finder::create()\n            ->name('*.sql')\n            ->depth(0)\n            ->sortByName()\n            ->in(__DIR__.DS.'Config'.DS.'update');\n\n        $database = new Database($con);\n\n        /** @var \\SplFileInfo $file */\n        foreach ($finder as $file) {\n            if (version_compare($currentVersion, $file->getBasename('.sql'), '<')) {\n                $database->insertSql(null, [$file->getPathname()]);\n            }\n        }\n    }\n")),(0,o.kt)("p",null,"if not you will have to add it.\nThis function is called when Thelia refresh module list (either in the admin page oy by command) and detect that the next version of your module is different than the current.\nAnd it will search and execute all sql files between two versions."),(0,o.kt)("h2",{id:"add-a-column-to-native-thelia-table"},"Add a column to native Thelia table"),(0,o.kt)("p",null,"In Thelia it is ",(0,o.kt)("strong",{parentName:"p"},"not")," possible to modify the native tables.",(0,o.kt)("br",{parentName:"p"}),"\n","The best practice to add columns is to create a new table with a foreign key attached to the base table."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-xml"},'    <table name="extend_customer_data" namespace="MyProject\\Model">\n        <column name="id" primaryKey="true" required="true" type="INTEGER" />\n        <column name="additional_column" type="VARCHAR" size="255" />\n        <foreign-key foreignTable="customer" name="fk_extend_customer_data_customer_id" onDelete="CASCADE" onUpdate="CASCADE">\n            <reference foreign="id" local="id" />\n        </foreign-key>\n        ...\n    </table>\n')))}c.isMDXComponent=!0}}]);